# Анализ обновления библиотеки Chessground с версии 9.0.4 до 9.9.0

## Информация о версиях

- **Текущая версия**: 9.0.4
- **Последняя стабильная версия в npm**: 9.2.1
- **Последняя версия на GitHub**: 9.9.0 (17 ноября 2025)
- **Дата анализа**: 12 января 2026 года

> **Примечание**: Версии 9.2.2 - 9.9.0 существуют в репозитории GitHub, но еще не опубликованы в npm. Для установки из npm доступна версия 9.2.1. Для использования более новых версий необходимо устанавливать напрямую из GitHub.

## Таблица анализа изменений

### Версии доступные в npm (до 9.2.1)

| Версия | Дата выпуска | Основные изменения | Тип изменения |
|--------|--------------|-------------------|---------------|
| **9.0.5** | 18 апреля 2024 | - Экспорт CSS переменных ширины и высоты с тремя дефисами в качестве алиасов<br>- Обновление dev-зависимостей<br>- Удаление обратной совместимости названия `addDimensionsCssVarsTo` | Минорное улучшение |
| **9.1.0** | 1 мая 2024 | - **Новая функция**: Добавлена опция `coordinatesOnSquares` для отображения координат на каждой клетке<br>- Улучшена работа с CSS для координат<br>- Оптимизированы CSS селекторы (удалено 8+ ненужных селекторов) | Функциональное обновление |
| **9.1.1** | 6 мая 2024 | - Сделано свойство `Config.coordinatesOnSquares` опциональным<br>- Типизация для новой функции координат | Исправление типов |
| **9.2.0** | 9 ноября 2024 | - **Новая функция**: Добавлен тип `Role` в `chessground/types`<br>- Улучшена типизация TypeScript | Улучшение типов |
| **9.2.1** | 15 мая 2025 | - **Исправление безопасности**: Устранена уязвимость prototype pollution в функции `deepMerge`, обнаруженная CodeQL<br>- Обновление зависимости esbuild с 0.24.0 до 0.25.0<br>- Обновление зависимости cross-spawn с 7.0.3 до 7.0.6<br>- Обновление зависимости micromatch с 4.0.5 до 4.0.8<br>- Обновление зависимости braces с 3.0.2 до 3.0.3<br>- Улучшен CSS для размещения и цвета текста координат<br>- Включена поддержка импорта CSS файлов из chessground assets в Next.js проектах | Исправления безопасности и багфиксы |

### Версии доступные только на GitHub (9.2.2 - 9.9.0)

> **Важно**: Эти версии еще не опубликованы в npm. Установка возможна только напрямую из GitHub репозитория.

| Версия | Дата выпуска | Основные изменения | Тип изменения |
|--------|--------------|-------------------|---------------|
| **9.2.2** | 27 мая 2025 | - Исправления и улучшения стабильности | Патч |
| **9.2.3** | 29 мая 2025 | - Дополнительные исправления | Патч |
| **9.4.0** | 27 июля 2025 | - **Новая функция**: Улучшена обрезка premove с учетом фигур противника<br>- Исправления для en passant в нестандартных позициях | Функциональное обновление |
| **9.4.1** | 2 августа 2025 | - Исправления edge cases для en passant<br>- Добавлены тесты в GitHub Actions | Патч |
| **9.5.0** | 7 августа 2025 | - **Новая функция**: SVG-фигуры под шахматными фигурами (новый слой отображения)<br>- Новая CSS плоскость для кастомных SVG | Функциональное обновление |
| **9.5.1** | 17 августа 2025 | - Добавлены новые SVG плоскости в base.css | Патч |
| **9.5.2** | 29 августа 2025 | - Уменьшен радиус измерения `pieceCloseTo` на √2 для лучшего тач-управления | Патч |
| **9.6.0** | 31 августа 2025 | - **Новая функция**: Добавлен параметр `touchIgnoreRadius` в публичный интерфейс<br>- Игнорирование касаний вокруг занятой клетки | Функциональное обновление |
| **9.7.0** | 18 сентября 2025 | - Исправление чтения неправильных FEN-позиций | Патч |
| **9.7.1** | 19 сентября 2025 | - Hotfix: исправлено исключение при вычислении легальных premoves | Патч |
| **9.7.2** | 20 сентября 2025 | - Исправление проблемы с наконечниками стрелок в Safari (регрессия из 9.5.0) | Патч |
| **9.7.4** | 5 октября 2025 | - Исправление premove для пешечного продвижения | Патч |
| **9.8.0** | 14 октября 2025 | - **Новая функция**: Возможность клиенту указывать дополнительные предикаты для premove<br>- Очистка фигур после клика/тапа вместо mouse down<br>- Исправление бага premove продвижения<br>- Улучшение `pos2key` для edge cases | Функциональное обновление |
| **9.8.1** | 14 октября 2025 | - Документирование процедуры релиза | Патч |
| **9.8.2** | 14 октября 2025 | - Обновление Config для кастомных premove предикатов | Патч |
| **9.8.3** | 17 октября 2025 | - Откат изменений очистки фигур (временно) | Откат |
| **9.8.4** | 21 октября 2025 | - Прозрачность рисунков при pending removal | Улучшение UX |
| **9.8.5** | 4 ноября 2025 | - Мемоизация определения Firefox Mac<br>- Исправление рисования стрелок при продвижении пешки в Firefox | Патч |
| **9.9.0** | 17 ноября 2025 | - **Breaking change**: Удалена `premove MobilityContext.canCastle`<br>- **Новая функция**: Подсветка последнего хода для рокировки ладьи<br>- Удалена логика обрезки premove (перенесена в lila)<br>- Обновлены ссылки на Svelte 5 wrapper | Функциональное обновление |

## Детальное описание новых функций

### Функции в npm версиях (9.0.5 - 9.2.1)

### 1. Координаты на каждой клетке (v9.1.0)

**Описание**: Новая опция конфигурации `coordinatesOnSquares`, которая позволяет отображать координаты шахматной доски (например, "e4", "d5") непосредственно на каждой клетке, а не только по краям доски.

**Использование**:
```typescript
{
  coordinatesOnSquares: true
}
```

**Преимущества**:
- Улучшает читаемость для обучающих целей
- Полезно для начинающих игроков
- Дополнительные варианты визуализации доски

### 2. Улучшенная типизация Role (v9.2.0)

**Описание**: Добавлен экспорт типа `Role` в `chessground/types`, что улучшает поддержку TypeScript.

**Преимущества**:
- Лучшая типобезопасность при работе с фигурами
- Улучшенная автодополнение в IDE

### 3. Исправление CSS импортов для Next.js (v9.2.1)

**Описание**: Включена поддержка импорта CSS файлов из chessground assets в проектах на Next.js.

**Преимущества**:
- Упрощает интеграцию с современными фреймворками
- Решает проблемы совместимости с Next.js

### 4. Улучшения CSS координат (v9.2.1)

**Описание**: Улучшен CSS для более точного размещения и управления цветом текста координат.

**Преимущества**:
- Лучшая визуальная согласованность
- Более гибкая настройка внешнего вида

### Функции в GitHub-только версиях (9.2.2 - 9.9.0)

> **Важно**: Эти функции доступны только при установке напрямую из GitHub

#### 5. SVG-фигуры под шахматными фигурами (v9.5.0)

**Описание**: Добавлена возможность отображать пользовательские SVG-фигуры на дополнительном слое под обычными шахматными фигурами.

**Преимущества**:
- Новые возможности визуализации
- Дополнительный слой для кастомных обозначений
- Лучший контроль над z-index элементов

#### 6. Параметр touchIgnoreRadius (v9.6.0)

**Описание**: Новый параметр конфигурации `touchIgnoreRadius` позволяет настроить область вокруг занятой клетки, в которой касания будут игнорироваться.

**Преимущества**:
- Улучшенное тач-управление на мобильных устройствах
- Снижение случайных касаний
- Настраиваемая чувствительность

#### 7. Кастомные premove предикаты (v9.8.0)

**Описание**: Возможность клиенту указывать дополнительные функции-предикаты для определения валидности premove.

**Преимущества**:
- Гибкость для нестандартных вариантов шахмат
- Больше контроля над логикой premove
- Поддержка кастомных правил

#### 8. Подсветка рокировки ладьи (v9.9.0)

**Описание**: При выполнении рокировки ладьей теперь подсвечивается правильная клетка, на которой находится король.

**Преимущества**:
- Улучшенная визуальная обратная связь
- Более интуитивное отображение рокировки

## Исправления безопасности

### Критическая уязвимость: Prototype Pollution (v9.2.1)

**Описание**: Была обнаружена и устранена уязвимость prototype pollution в функции `deepMerge`. Эта уязвимость была идентифицирована с помощью инструмента статического анализа кода CodeQL.

**Уровень критичности**: Средний

**Влияние**: Потенциальная возможность изменения прототипов объектов JavaScript, что может привести к неожиданному поведению или уязвимостям безопасности.

**Статус**: Исправлено в версии 9.2.1

## Обновления зависимостей

Между версиями были обновлены следующие зависимости (в основном dev-зависимости):

| Зависимость | Старая версия | Новая версия | Причина |
|-------------|---------------|--------------|---------|
| esbuild | 0.24.0 | 0.25.0 | Обновление сборщика |
| cross-spawn | 7.0.3 | 7.0.6 | Исправление безопасности |
| micromatch | 4.0.5 | 4.0.8 | Исправление безопасности |
| braces | 3.0.2 | 3.0.3 | Исправление безопасности |

## Оценка безопасности обновления для продакшна

### Обновление до версии 9.2.1 (npm): ✅ НАСТОЯТЕЛЬНО РЕКОМЕНДУЕТСЯ

**Уровень риска**: Низкий

**Обоснование**:

1. **Исправления безопасности** (Критично):
   - Версия 9.2.1 содержит важное исправление уязвимости prototype pollution
   - Обновлены зависимости с известными уязвимостями безопасности
   - **Настоятельно рекомендуется** для продакшн-окружения

2. **Обратная совместимость** (Отлично):
   - Все изменения между 9.0.4 и 9.2.1 являются обратно совместимыми
   - Новые функции являются опциональными (например, `coordinatesOnSquares`)
   - Никаких breaking changes не зафиксировано
   - Существующий код продолжит работать без изменений

3. **Новые функции** (Низкий риск):
   - Все новые функции опциональны
   - Не требуют изменений существующего кода
   - Можно использовать при необходимости

4. **Улучшения TypeScript** (Плюс):
   - Улучшена типизация без изменения API
   - Лучшая поддержка в IDE

5. **Обновления зависимостей** (Положительно):
   - Все обновления зависимостей являются патч-версиями или минорными
   - Устраняют известные уязвимости безопасности

### Рекомендации по обновлению

#### Вариант 1: Обновление до стабильной версии npm (9.2.1) - РЕКОМЕНДУЕТСЯ

##### Шаг 1: Обновление версии
```bash
# Через npm
npm install chessground@9.2.1

# Через yarn
yarn add chessground@9.2.1
```

#### Вариант 2: Обновление до последней GitHub версии (9.9.0) - ДЛЯ ПРОДВИНУТЫХ ПОЛЬЗОВАТЕЛЕЙ

**Внимание**: Версия 9.9.0 содержит breaking changes!

##### Шаг 1: Установка из GitHub
```bash
# Через npm
npm install lichess-org/chessground#v9.9.0

# Через yarn
yarn add lichess-org/chessground#v9.9.0
```

##### Breaking Changes в 9.9.0:
- Удалена `premove MobilityContext.canCastle` - если вы используете эту функцию, необходимо обновить код
- Логика обрезки premove перенесена на сторону сервера (lila) - убедитесь, что ваш сервер поддерживает это

#### Общие рекомендации по тестированию

##### Шаг 2: Тестирование
1. Запустите существующие тесты
2. Проверьте основные сценарии использования:
   - Отображение доски
   - Перемещение фигур
   - Стрелки и выделения
   - Анимации
   - Premove (особенно важно для версий 9.4.0+)
   - Тач-управление (если используете версии 9.5.2+)

#### Шаг 3: Опциональное использование новых функций
Если требуется, можно активировать новые функции:

```typescript
// Пример использования координат на клетках (9.1.0+)
const config = {
  coordinatesOnSquares: true,
  // ... остальные настройки
};

// Пример использования touchIgnoreRadius (9.6.0+, только GitHub)
const config = {
  touchIgnoreRadius: 0.7, // значение от 0 до 1
  // ... остальные настройки
};
```

### Потенциальные проблемы

**Для версии 9.2.1 (npm)**:
- Если вы используете устаревшее имя `addDimensionsCssVarsTo`, его нужно обновить (удалено в 9.0.5)
- Возможны минимальные визуальные изменения CSS для координат

**Для версии 9.9.0 (GitHub)**:
- **Breaking change**: Удалена `premove MobilityContext.canCastle`
- Логика premove изменена - требуется серверная поддержка
- Изменено поведение очистки фигур (несколько откатов в версиях 9.8.x)
- Требуется тщательное тестирование premove функционала

### План отката (на случай проблем)

```bash
# Откат к версии 9.0.4
npm install chessground@9.0.4
# или
yarn add chessground@9.0.4

# Откат к стабильной версии 9.2.1 (если устанавливали из GitHub)
npm install chessground@9.2.1
# или
yarn add chessground@9.2.1
```

## Сравнение версий: npm vs GitHub

| Критерий | 9.2.1 (npm) | 9.9.0 (GitHub) |
|----------|-------------|-----------------|
| **Стабильность** | ✅ Стабильная, протестированная | ⚠️ Может содержать нестабильности |
| **Установка** | ✅ Простая через npm/yarn | ⚠️ Требуется установка из GitHub |
| **Breaking changes** | ❌ Нет | ⚠️ Да, удалены некоторые API |
| **Новые функции** | Базовые улучшения | Много новых функций |
| **Безопасность** | ✅ Исправлена уязвимость | ✅ Исправлена уязвимость |
| **Обновления зависимостей** | ✅ Да | ✅ Да |
| **Premove улучшения** | Базовые | Значительные изменения |
| **Тач-управление** | Стандартное | Улучшенное с `touchIgnoreRadius` |
| **SVG слои** | Стандартные | Расширенные возможности |
| **Рекомендация для продакшна** | ✅ Рекомендуется | ⚠️ Только для продвинутых пользователей |

## Заключение

### Для большинства пользователей: Обновление до 9.2.1 (npm)

**Обновление с версии 9.0.4 до 9.2.1 НАСТОЯТЕЛЬНО РЕКОМЕНДУЕТСЯ для продакшн-окружения.**

Причины:
- ✅ Исправлена важная уязвимость безопасности (prototype pollution)
- ✅ Обновлены зависимости с известными уязвимостями
- ✅ 100% обратная совместимость
- ✅ Новые полезные функции (опциональные)
- ✅ Улучшенная типизация TypeScript
- ✅ Никаких breaking changes
- ✅ Низкий риск проблем
- ✅ Простая установка из npm

**Рекомендуемый срок обновления**: В ближайшее время (в течение 1-2 недель)

**Приоритет**: Высокий (из-за исправлений безопасности)

### Для продвинутых пользователей: Обновление до 9.9.0 (GitHub)

**Возможно, но требует осторожности и тщательного тестирования.**

Причины ЗА:
- ✅ Все функции из 9.2.1 плюс много новых
- ✅ Улучшенное premove управление
- ✅ Расширенные возможности SVG
- ✅ Лучшее тач-управление
- ✅ Подсветка рокировки

Причины ПРОТИВ:
- ⚠️ Содержит breaking changes
- ⚠️ Требуется установка из GitHub
- ⚠️ Может содержать нестабильности
- ⚠️ Требуется серверная поддержка для новой логики premove
- ⚠️ Необходимо тщательное тестирование

**Рекомендация**: Подождите официальной публикации в npm, если нет критической необходимости в новых функциях.

### Итоговые рекомендации

1. **Для продакшна**: Используйте версию **9.2.1** из npm
2. **Для разработки/тестирования**: Можете попробовать **9.9.0** из GitHub
3. **Для максимальной стабильности**: Оставайтесь на **9.2.1** до официальной публикации новых версий в npm

**Следующий шаг**: Следите за публикацией версий 9.3.0+ в npm для получения новых функций без рисков нестабильности.
